/**
 * generated by Xtext 2.16.0
 */
package com.mimacom.ddd.sm.sim.tests;

import com.google.inject.Inject;
import com.google.inject.Injector;
import com.google.inject.Provider;
import com.mimacom.ddd.dm.base.base.DAggregate;
import com.mimacom.ddd.dm.base.base.DAttribute;
import com.mimacom.ddd.dm.base.base.DEntityType;
import com.mimacom.ddd.dm.base.base.DEnumeration;
import com.mimacom.ddd.dm.base.base.DFeature;
import com.mimacom.ddd.dm.base.base.DInformationModel;
import com.mimacom.ddd.dm.base.base.DLiteral;
import com.mimacom.ddd.dm.base.base.DModel;
import com.mimacom.ddd.dm.base.base.DNamespace;
import com.mimacom.ddd.dm.base.base.DPrimitive;
import com.mimacom.ddd.dm.base.base.DQuery;
import com.mimacom.ddd.dm.base.base.DQueryParameter;
import com.mimacom.ddd.dm.base.base.DType;
import com.mimacom.ddd.dm.base.base.ITransposition;
import com.mimacom.ddd.dm.base.base.TImplicitTransposition;
import com.mimacom.ddd.dm.base.base.TTranspositionRule;
import com.mimacom.ddd.dm.base.transpose.TAggregateTransposition;
import com.mimacom.ddd.dm.base.transpose.TEntityTypeTransposition;
import com.mimacom.ddd.dm.base.transpose.TEnumerationTransposition;
import com.mimacom.ddd.dm.base.transpose.TFeatureTransposition;
import com.mimacom.ddd.dm.base.transpose.TGrabAggregateRule;
import com.mimacom.ddd.dm.base.transpose.TGrabRule;
import com.mimacom.ddd.dm.base.transpose.TLiteralTransposition;
import com.mimacom.ddd.dm.base.transpose.TPrimitiveTransposition;
import com.mimacom.ddd.dm.base.transpose.TQueryParameterTransposition;
import com.mimacom.ddd.dm.base.transpose.TQueryTransposition;
import com.mimacom.ddd.dm.base.transpose.TransposeIndex;
import com.mimacom.ddd.dm.base.transpose.TransposeUtil;
import com.mimacom.ddd.dm.dim.DimStandaloneSetup;
import com.mimacom.ddd.dm.dmx.DmxArchetype;
import com.mimacom.ddd.dm.dmx.DmxModel;
import com.mimacom.ddd.dm.dmx.DmxStandaloneSetup;
import com.mimacom.ddd.sm.sim.SInformationModel;
import com.mimacom.ddd.sm.sim.tests.SimInjectorProvider;
import java.util.List;
import org.eclipse.emf.common.util.EList;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.eclipse.xtend2.lib.StringConcatenation;
import org.eclipse.xtext.naming.QualifiedName;
import org.eclipse.xtext.resource.IEObjectDescription;
import org.eclipse.xtext.testing.InjectWith;
import org.eclipse.xtext.testing.extensions.InjectionExtension;
import org.eclipse.xtext.testing.util.ParseHelper;
import org.eclipse.xtext.xbase.lib.Exceptions;
import org.eclipse.xtext.xbase.lib.IterableExtensions;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;

@ExtendWith(InjectionExtension.class)
@InjectWith(SimInjectorProvider.class)
@SuppressWarnings("all")
public class SimTranspositionTest {
  private static final QualifiedName DM_TYPES_AT = QualifiedName.create("dm", "types", "AT");
  
  private static final QualifiedName DM_DT = QualifiedName.create("DM", "DT");
  
  private static final QualifiedName DM_EN = QualifiedName.create("DM", "En");
  
  private static final QualifiedName SM_SM1_ST = QualifiedName.create("SM", "SM1", "ST");
  
  @Inject
  private ParseHelper<DNamespace> simParseHelper;
  
  private final ParseHelper<DNamespace> dmxParseHelper;
  
  private final ParseHelper<DNamespace> dimParseHelper;
  
  @Inject
  private Provider<ResourceSet> resourceSetProvider;
  
  @Inject
  private TransposeIndex index;
  
  public SimTranspositionTest() {
    final Injector dimInjector = new DimStandaloneSetup().createInjectorAndDoEMFRegistration();
    this.dimParseHelper = dimInjector.<ParseHelper>getInstance(ParseHelper.class);
    final Injector dmxInjector = new DmxStandaloneSetup().createInjectorAndDoEMFRegistration();
    this.dmxParseHelper = dmxInjector.<ParseHelper>getInstance(ParseHelper.class);
  }
  
  protected DmxModel loadDmx(final ResourceSet rs) {
    try {
      StringConcatenation _builder = new StringConcatenation();
      _builder.append("namespace dm.types");
      _builder.newLine();
      _builder.append("archetype AT is NUMBER");
      _builder.newLine();
      final DNamespace dmxNS = this.dmxParseHelper.parse(_builder, rs);
      this.assertNoParseErrors(dmxNS, "dmx");
      DModel _model = dmxNS.getModel();
      final DmxModel dmx = ((DmxModel) _model);
      Assertions.assertNotNull(dmx);
      Assertions.assertEquals(1, dmx.getTypes().size());
      final DType at = IterableExtensions.<DType>head(dmx.getTypes());
      Assertions.assertTrue((at instanceof DmxArchetype));
      final List<IEObjectDescription> descs = IterableExtensions.<IEObjectDescription>toList(this.index.getExportedDTypeDescriptions(at));
      Assertions.assertEquals(1, descs.size());
      Assertions.assertEquals(SimTranspositionTest.DM_TYPES_AT, IterableExtensions.<IEObjectDescription>head(descs).getQualifiedName());
      final List<IEObjectDescription> visibleDescs = IterableExtensions.<IEObjectDescription>toList(this.index.getVisibleDTypeDescriptions(at));
      Assertions.assertEquals(1, visibleDescs.size());
      Assertions.assertEquals(SimTranspositionTest.DM_TYPES_AT, IterableExtensions.<IEObjectDescription>head(visibleDescs).getQualifiedName());
      return dmx;
    } catch (Throwable _e) {
      throw Exceptions.sneakyThrow(_e);
    }
  }
  
  protected DInformationModel loadSimpleDim(final ResourceSet rs, final DmxArchetype at) {
    try {
      StringConcatenation _builder = new StringConcatenation();
      _builder.append("domain DM");
      _builder.newLine();
      _builder.append("information model DIM {");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("primitive DT redefines AT");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("enumeration En { L1, L2 }");
      _builder.newLine();
      _builder.append("}");
      _builder.newLine();
      final DNamespace dmNS = this.dimParseHelper.parse(_builder, rs);
      this.assertNoParseErrors(dmNS, "dm");
      DModel _model = dmNS.getModel();
      final DInformationModel dim = ((DInformationModel) _model);
      Assertions.assertNotNull(dim);
      Assertions.assertEquals(2, dim.getTypes().size());
      DType _get = dim.getTypes().get(0);
      final DPrimitive dt = ((DPrimitive) _get);
      Assertions.assertFalse(dt.isSynthetic());
      Assertions.assertEquals("DT", dt.getName());
      Assertions.assertEquals(at, dt.getRedefines());
      DType _get_1 = dim.getTypes().get(1);
      final DEnumeration en = ((DEnumeration) _get_1);
      Assertions.assertFalse(dt.isSynthetic());
      Assertions.assertEquals("En", en.getName());
      Assertions.assertEquals(2, en.getLiterals().size());
      Assertions.assertEquals("L1", en.getLiterals().get(0).getName());
      Assertions.assertEquals("L2", en.getLiterals().get(1).getName());
      final List<IEObjectDescription> descs = IterableExtensions.<IEObjectDescription>toList(this.index.getExportedDTypeDescriptions(dt));
      Assertions.assertEquals(2, descs.size());
      Assertions.assertEquals(SimTranspositionTest.DM_DT, descs.get(0).getQualifiedName());
      Assertions.assertEquals(SimTranspositionTest.DM_EN, descs.get(1).getQualifiedName());
      final List<IEObjectDescription> visibleDescs = IterableExtensions.<IEObjectDescription>toList(this.index.getVisibleDTypeDescriptions(dt));
      Assertions.assertEquals(3, visibleDescs.size());
      Assertions.assertEquals(SimTranspositionTest.DM_TYPES_AT, visibleDescs.get(0).getQualifiedName());
      Assertions.assertEquals(SimTranspositionTest.DM_DT, visibleDescs.get(1).getQualifiedName());
      Assertions.assertEquals(SimTranspositionTest.DM_EN, visibleDescs.get(2).getQualifiedName());
      return dim;
    } catch (Throwable _e) {
      throw Exceptions.sneakyThrow(_e);
    }
  }
  
  protected DInformationModel loadComponentDim(final ResourceSet rs, final DmxArchetype at) {
    try {
      StringConcatenation _builder = new StringConcatenation();
      _builder.append("domain DM");
      _builder.newLine();
      _builder.append("information model DIM {");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("component AComp {");
      _builder.newLine();
      _builder.append("\t\t");
      _builder.append("query q(p1 : AT) : AT");
      _builder.newLine();
      _builder.append("\t\t");
      _builder.append("main entity A {");
      _builder.newLine();
      _builder.append("\t\t\t");
      _builder.append("x : AT");
      _builder.newLine();
      _builder.append("\t\t");
      _builder.append("}");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("}");
      _builder.newLine();
      _builder.append("}");
      _builder.newLine();
      final DNamespace dimNS = this.dimParseHelper.parse(_builder, rs);
      this.assertNoParseErrors(dimNS, "dm");
      DModel _model = dimNS.getModel();
      final DInformationModel dim = ((DInformationModel) _model);
      Assertions.assertNotNull(dim);
      Assertions.assertEquals(1, dim.getAggregates().size());
      final DAggregate acomp = dim.getAggregates().get(0);
      Assertions.assertFalse(acomp.isSynthetic());
      Assertions.assertEquals("AComp", acomp.getName());
      Assertions.assertEquals(1, acomp.getFeatures().size());
      DFeature _get = acomp.getFeatures().get(0);
      final DQuery q = ((DQuery) _get);
      Assertions.assertFalse(q.isSynthetic());
      Assertions.assertEquals("q", q.getName());
      Assertions.assertEquals(at, q.getType());
      {
        Assertions.assertEquals(1, q.getParameters().size());
        DQueryParameter _get_1 = q.getParameters().get(0);
        final DQueryParameter p1 = ((DQueryParameter) _get_1);
        Assertions.assertFalse(p1.isSynthetic());
        Assertions.assertEquals("p1", p1.getName());
        Assertions.assertEquals(at, p1.getType());
      }
      Assertions.assertEquals(1, acomp.getTypes().size());
      DType _get_1 = acomp.getTypes().get(0);
      final DEntityType a = ((DEntityType) _get_1);
      Assertions.assertFalse(a.isSynthetic());
      Assertions.assertEquals("A", a.getName());
      {
        Assertions.assertEquals(1, a.getFeatures().size());
        DFeature _get_2 = a.getFeatures().get(0);
        final DAttribute x = ((DAttribute) _get_2);
        Assertions.assertFalse(x.isSynthetic());
        Assertions.assertEquals("x", x.getName());
        Assertions.assertEquals(at, x.getType());
      }
      return dim;
    } catch (Throwable _e) {
      throw Exceptions.sneakyThrow(_e);
    }
  }
  
  @Test
  public void grabPrimitive() {
    try {
      final ResourceSet resourceSet = this.resourceSetProvider.get();
      final DmxModel dmx = this.loadDmx(resourceSet);
      DType _get = dmx.getTypes().get(0);
      final DmxArchetype at = ((DmxArchetype) _get);
      final DInformationModel dim = this.loadSimpleDim(resourceSet, at);
      DType _get_1 = dim.getTypes().get(0);
      final DPrimitive dt = ((DPrimitive) _get_1);
      StringConcatenation _builder = new StringConcatenation();
      _builder.append("system SM");
      _builder.newLine();
      _builder.append("base information model SM1 {");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("grab primitive DM.DT as ST");
      _builder.newLine();
      _builder.append("}");
      _builder.newLine();
      final DNamespace smNS = this.simParseHelper.parse(_builder, resourceSet);
      this.assertNoParseErrors(smNS, "sm");
      DModel _model = smNS.getModel();
      final SInformationModel sm = ((SInformationModel) _model);
      Assertions.assertNotNull(sm);
      Assertions.assertEquals(2, sm.getTypes().size());
      DType _get_2 = sm.getTypes().get(0);
      final TPrimitiveTransposition stDeduction = ((TPrimitiveTransposition) _get_2);
      Assertions.assertFalse(stDeduction.isSynthetic());
      TTranspositionRule _transpositionRule = stDeduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule instanceof TGrabRule));
      DType _get_3 = sm.getTypes().get(1);
      final DPrimitive st = ((DPrimitive) _get_3);
      Assertions.assertEquals("ST", st.getName());
      Assertions.assertTrue(st.isSynthetic());
      Assertions.assertEquals(stDeduction, st.getTransposedBy());
      Assertions.assertEquals(dt, st.getTransposedBy().getTranspositionRule().getSource());
      final List<IEObjectDescription> descs = IterableExtensions.<IEObjectDescription>toList(this.index.getExportedDTypeDescriptions(st));
      Assertions.assertEquals(1, descs.size());
      Assertions.assertEquals(SimTranspositionTest.SM_SM1_ST, descs.get(0).getQualifiedName());
      final List<IEObjectDescription> visibleDescs = IterableExtensions.<IEObjectDescription>toList(this.index.getVisibleDTypeDescriptions(st));
      Assertions.assertEquals(4, visibleDescs.size());
      Assertions.assertEquals(SimTranspositionTest.SM_SM1_ST, visibleDescs.get(3).getQualifiedName());
      final List<IEObjectDescription> visibleMapings = IterableExtensions.<IEObjectDescription>toList(this.index.getVisibleTTypeMappingDescriptions(st, TransposeUtil.getDeductionSourceQNForIndex(SimTranspositionTest.DM_DT)));
      Assertions.assertEquals(1, visibleMapings.size());
      Assertions.assertEquals(SimTranspositionTest.SM_SM1_ST, TransposeUtil.getDeductionTargetQN(visibleMapings.get(0)));
    } catch (Throwable _e) {
      throw Exceptions.sneakyThrow(_e);
    }
  }
  
  @Test
  public void grabEnumeration() {
    try {
      final ResourceSet resourceSet = this.resourceSetProvider.get();
      final DmxModel dmx = this.loadDmx(resourceSet);
      DType _get = dmx.getTypes().get(0);
      final DmxArchetype at = ((DmxArchetype) _get);
      final DInformationModel dim = this.loadSimpleDim(resourceSet, at);
      DType _get_1 = dim.getTypes().get(1);
      final DEnumeration en = ((DEnumeration) _get_1);
      final DLiteral l1 = en.getLiterals().get(0);
      final DLiteral l2 = en.getLiterals().get(1);
      StringConcatenation _builder = new StringConcatenation();
      _builder.append("system SM");
      _builder.newLine();
      _builder.append("base information model SM1 {");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("grab enumeration DM.En as SEn1 { add L3 }");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("grab enumeration DM.En as SEn2 { grab L2 as L0 }");
      _builder.newLine();
      _builder.append("}");
      _builder.newLine();
      final DNamespace smNS = this.simParseHelper.parse(_builder, resourceSet);
      this.assertNoParseErrors(smNS, "sm");
      DModel _model = smNS.getModel();
      final SInformationModel sm = ((SInformationModel) _model);
      Assertions.assertNotNull(sm);
      Assertions.assertEquals(4, sm.getTypes().size());
      DType _get_2 = sm.getTypes().get(0);
      final TEnumerationTransposition sen1Deduction = ((TEnumerationTransposition) _get_2);
      Assertions.assertFalse(sen1Deduction.isSynthetic());
      TTranspositionRule _transpositionRule = sen1Deduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule instanceof TGrabRule));
      DType _get_3 = sm.getTypes().get(1);
      final TEnumerationTransposition sen2Deduction = ((TEnumerationTransposition) _get_3);
      Assertions.assertFalse(sen2Deduction.isSynthetic());
      TTranspositionRule _transpositionRule_1 = sen2Deduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule_1 instanceof TGrabRule));
      {
        DType _get_4 = sm.getTypes().get(2);
        final DEnumeration sen1 = ((DEnumeration) _get_4);
        Assertions.assertEquals("SEn1", sen1.getName());
        Assertions.assertTrue(sen1.isSynthetic());
        Assertions.assertEquals(sen1Deduction, sen1.getTransposedBy());
        Assertions.assertEquals(en, sen1.getTransposedBy().getTranspositionRule().getSource());
        Assertions.assertEquals(3, sen1.getLiterals().size());
        final DLiteral sl1 = sen1.getLiterals().get(0);
        Assertions.assertEquals("L1", sl1.getName());
        ITransposition _transposedBy = sl1.getTransposedBy();
        final TImplicitTransposition sl1Deduction = ((TImplicitTransposition) _transposedBy);
        TTranspositionRule _transpositionRule_2 = sl1Deduction.getTranspositionRule();
        Assertions.assertTrue((_transpositionRule_2 instanceof TGrabRule));
        Assertions.assertEquals(l1, sl1Deduction.getTranspositionRule().getSource());
        Assertions.assertEquals("L2", sen1.getLiterals().get(1).getName());
        final DLiteral sl3 = sen1.getLiterals().get(2);
        Assertions.assertEquals("L3", sl3.getName());
        Assertions.assertNull(sl3.getTransposedBy());
      }
      {
        DType _get_4 = sm.getTypes().get(3);
        final DEnumeration sen2 = ((DEnumeration) _get_4);
        Assertions.assertEquals("SEn2", sen2.getName());
        Assertions.assertTrue(sen2.isSynthetic());
        Assertions.assertEquals(sen2Deduction, sen2.getTransposedBy());
        Assertions.assertEquals(en, sen2.getTransposedBy().getTranspositionRule().getSource());
        Assertions.assertEquals(1, sen2.getLiterals().size());
        final DLiteral sl0 = sen2.getLiterals().get(0);
        Assertions.assertEquals("L0", sl0.getName());
        ITransposition _transposedBy = sl0.getTransposedBy();
        final TLiteralTransposition sl0Deduction = ((TLiteralTransposition) _transposedBy);
        TTranspositionRule _transpositionRule_2 = sl0Deduction.getTranspositionRule();
        Assertions.assertTrue((_transpositionRule_2 instanceof TGrabRule));
        Assertions.assertEquals(l2, sl0Deduction.getTranspositionRule().getSource());
      }
    } catch (Throwable _e) {
      throw Exceptions.sneakyThrow(_e);
    }
  }
  
  @Test
  public void grabEntity() {
    try {
      final ResourceSet resourceSet = this.resourceSetProvider.get();
      final DmxModel dmx = this.loadDmx(resourceSet);
      DType _get = dmx.getTypes().get(0);
      final DmxArchetype at = ((DmxArchetype) _get);
      final DInformationModel dim = this.loadComponentDim(resourceSet, at);
      final DAggregate acomp = dim.getAggregates().get(0);
      DType _get_1 = acomp.getTypes().get(0);
      final DEntityType a = ((DEntityType) _get_1);
      DFeature _get_2 = a.getFeatures().get(0);
      final DAttribute x = ((DAttribute) _get_2);
      StringConcatenation _builder = new StringConcatenation();
      _builder.append("system SM");
      _builder.newLine();
      _builder.append("core information model SM1 {");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("grab primitive dm.types.AT as ST");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("grab root entity DM.A as SMA1 { add y : ST}");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("grab root entity DM.A as SMA2 { grab x}");
      _builder.newLine();
      _builder.append("}");
      _builder.newLine();
      final DNamespace smNS = this.simParseHelper.parse(_builder, resourceSet);
      this.assertNoParseErrors(smNS, "sm");
      DModel _model = smNS.getModel();
      final SInformationModel sm = ((SInformationModel) _model);
      Assertions.assertNotNull(sm);
      Assertions.assertEquals(6, sm.getTypes().size());
      DType _get_3 = sm.getTypes().get(0);
      final TPrimitiveTransposition stDeduction = ((TPrimitiveTransposition) _get_3);
      Assertions.assertFalse(stDeduction.isSynthetic());
      TTranspositionRule _transpositionRule = stDeduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule instanceof TGrabRule));
      final List<IEObjectDescription> descs2 = IterableExtensions.<IEObjectDescription>toList(this.index.getExportedDTypeDescriptions(stDeduction));
      final List<IEObjectDescription> visibleDTypeDescs2 = IterableExtensions.<IEObjectDescription>toList(this.index.getVisibleDTypeDescriptions(stDeduction));
      final List<IEObjectDescription> visibleDeductionDescs2 = IterableExtensions.<IEObjectDescription>toList(this.index.getVisibleTTypeMappingDescriptions(stDeduction, SimTranspositionTest.DM_TYPES_AT));
      DType _get_4 = sm.getTypes().get(1);
      final TEntityTypeTransposition sma1Deduction = ((TEntityTypeTransposition) _get_4);
      Assertions.assertFalse(sma1Deduction.isSynthetic());
      TTranspositionRule _transpositionRule_1 = sma1Deduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule_1 instanceof TGrabRule));
      DType _get_5 = sm.getTypes().get(2);
      final TEntityTypeTransposition sma2Deduction = ((TEntityTypeTransposition) _get_5);
      Assertions.assertFalse(sma2Deduction.isSynthetic());
      TTranspositionRule _transpositionRule_2 = sma2Deduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule_2 instanceof TGrabRule));
      DType _get_6 = sm.getTypes().get(3);
      final DPrimitive st = ((DPrimitive) _get_6);
      Assertions.assertEquals("ST", st.getName());
      Assertions.assertTrue(st.isSynthetic());
      Assertions.assertEquals(stDeduction, st.getTransposedBy());
      Assertions.assertEquals(at, st.getTransposedBy().getTranspositionRule().getSource());
      DType _get_7 = sm.getTypes().get(4);
      final DEntityType sma1 = ((DEntityType) _get_7);
      Assertions.assertEquals("SMA1", sma1.getName());
      Assertions.assertTrue(sma1.isSynthetic());
      Assertions.assertEquals(sma1Deduction, sma1.getTransposedBy());
      Assertions.assertEquals(a, sma1.getTransposedBy().getTranspositionRule().getSource());
      {
        Assertions.assertEquals(2, sma1.getFeatures().size());
        DFeature _get_8 = sma1.getFeatures().get(0);
        final DAttribute smx = ((DAttribute) _get_8);
        Assertions.assertTrue(smx.isSynthetic());
        Assertions.assertEquals("x", smx.getName());
        Assertions.assertEquals(st, smx.getType());
        ITransposition _transposedBy = smx.getTransposedBy();
        final TImplicitTransposition smxDeduction = ((TImplicitTransposition) _transposedBy);
        TTranspositionRule _transpositionRule_3 = smxDeduction.getTranspositionRule();
        Assertions.assertTrue((_transpositionRule_3 instanceof TGrabRule));
        Assertions.assertEquals(x, smx.getTransposedBy().getTranspositionRule().getSource());
        DFeature _get_9 = sma1.getFeatures().get(1);
        final DAttribute smy = ((DAttribute) _get_9);
        Assertions.assertTrue(smy.isSynthetic());
        Assertions.assertEquals("y", smy.getName());
        Assertions.assertEquals(st, smy.getType());
        Assertions.assertNull(smy.getTransposedBy());
      }
      DType _get_8 = sm.getTypes().get(5);
      final DEntityType sma2 = ((DEntityType) _get_8);
      Assertions.assertEquals("SMA2", sma2.getName());
      Assertions.assertTrue(sma2.isSynthetic());
      Assertions.assertEquals(sma2Deduction, sma2.getTransposedBy());
      Assertions.assertEquals(a, sma2.getTransposedBy().getTranspositionRule().getSource());
      {
        Assertions.assertEquals(1, sma2.getFeatures().size());
        DFeature _get_9 = sma2.getFeatures().get(0);
        final DAttribute smx = ((DAttribute) _get_9);
        Assertions.assertTrue(smx.isSynthetic());
        Assertions.assertEquals("x", smx.getName());
        Assertions.assertEquals(st, smx.getType());
        ITransposition _transposedBy = smx.getTransposedBy();
        final TFeatureTransposition smxDeduction = ((TFeatureTransposition) _transposedBy);
        TTranspositionRule _transpositionRule_3 = smxDeduction.getTranspositionRule();
        Assertions.assertTrue((_transpositionRule_3 instanceof TGrabRule));
        Assertions.assertEquals(x, smx.getTransposedBy().getTranspositionRule().getSource());
      }
    } catch (Throwable _e) {
      throw Exceptions.sneakyThrow(_e);
    }
  }
  
  @Test
  public void grabQuery() {
    try {
      final ResourceSet resourceSet = this.resourceSetProvider.get();
      final DmxModel dmx = this.loadDmx(resourceSet);
      DType _get = dmx.getTypes().get(0);
      final DmxArchetype at = ((DmxArchetype) _get);
      final DInformationModel dim = this.loadComponentDim(resourceSet, at);
      final DAggregate acomp = dim.getAggregates().get(0);
      DFeature _get_1 = acomp.getFeatures().get(0);
      final DQuery q = ((DQuery) _get_1);
      DQueryParameter _get_2 = q.getParameters().get(0);
      final DQueryParameter p1 = ((DQueryParameter) _get_2);
      StringConcatenation _builder = new StringConcatenation();
      _builder.append("system SM");
      _builder.newLine();
      _builder.append("core information model SM1 {");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("grab primitive dm.types.AT as ST");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("grab aggregate DM.AComp as SAggr {");
      _builder.newLine();
      _builder.append("\t\t");
      _builder.append("grab query q as sq1 (add p2 : ST)");
      _builder.newLine();
      _builder.append("\t\t");
      _builder.append("grab query q as sq2 (grab p1 as p0)");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("}");
      _builder.newLine();
      _builder.append("}");
      _builder.newLine();
      final DNamespace smNS = this.simParseHelper.parse(_builder, resourceSet);
      this.assertNoParseErrors(smNS, "sm");
      DModel _model = smNS.getModel();
      final SInformationModel sm = ((SInformationModel) _model);
      Assertions.assertNotNull(sm);
      Assertions.assertEquals(2, sm.getTypes().size());
      DType _get_3 = sm.getTypes().get(0);
      final TPrimitiveTransposition stDeduction = ((TPrimitiveTransposition) _get_3);
      Assertions.assertFalse(stDeduction.isSynthetic());
      TTranspositionRule _transpositionRule = stDeduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule instanceof TGrabRule));
      DType _get_4 = sm.getTypes().get(1);
      final DPrimitive st = ((DPrimitive) _get_4);
      Assertions.assertEquals("ST", st.getName());
      Assertions.assertTrue(st.isSynthetic());
      Assertions.assertEquals(stDeduction, st.getTransposedBy());
      Assertions.assertEquals(at, st.getTransposedBy().getTranspositionRule().getSource());
      Assertions.assertEquals(2, sm.getAggregates().size());
      DAggregate _get_5 = sm.getAggregates().get(0);
      final TAggregateTransposition sAggrDeduction = ((TAggregateTransposition) _get_5);
      Assertions.assertFalse(sAggrDeduction.isSynthetic());
      TTranspositionRule _transpositionRule_1 = sAggrDeduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule_1 instanceof TGrabAggregateRule));
      Assertions.assertEquals(2, sAggrDeduction.getFeatures().size());
      DFeature _get_6 = sAggrDeduction.getFeatures().get(0);
      final TQueryTransposition sq1Deduction = ((TQueryTransposition) _get_6);
      DFeature _get_7 = sAggrDeduction.getFeatures().get(1);
      final TQueryTransposition sq2Deduction = ((TQueryTransposition) _get_7);
      DAggregate _get_8 = sm.getAggregates().get(1);
      final DAggregate sAggr = ((DAggregate) _get_8);
      Assertions.assertTrue(sAggr.isSynthetic());
      Assertions.assertEquals(sAggrDeduction, sAggr.getTransposedBy());
      Assertions.assertEquals(acomp, sAggr.getTransposedBy().getTranspositionRule().getSource());
      Assertions.assertEquals(2, sAggr.getFeatures().size());
      DFeature _get_9 = sAggr.getFeatures().get(0);
      final DQuery sq1 = ((DQuery) _get_9);
      Assertions.assertEquals("sq1", sq1.getName());
      Assertions.assertTrue(sq1.isSynthetic());
      Assertions.assertEquals(sq1Deduction, sq1.getTransposedBy());
      Assertions.assertEquals(q, sq1.getTransposedBy().getTranspositionRule().getSource());
      {
        Assertions.assertEquals(2, sq1.getParameters().size());
        DQueryParameter _get_10 = sq1.getParameters().get(0);
        final DQueryParameter sp1 = ((DQueryParameter) _get_10);
        Assertions.assertTrue(sp1.isSynthetic());
        Assertions.assertEquals("p1", sp1.getName());
        Assertions.assertEquals(st, sp1.getType());
        ITransposition _transposedBy = sp1.getTransposedBy();
        final TImplicitTransposition sp1Deduction = ((TImplicitTransposition) _transposedBy);
        TTranspositionRule _transpositionRule_2 = sp1Deduction.getTranspositionRule();
        Assertions.assertTrue((_transpositionRule_2 instanceof TGrabRule));
        Assertions.assertEquals(p1, sp1.getTransposedBy().getTranspositionRule().getSource());
        DQueryParameter _get_11 = sq1.getParameters().get(1);
        final DQueryParameter sp2 = ((DQueryParameter) _get_11);
        Assertions.assertTrue(sp2.isSynthetic());
        Assertions.assertEquals("p2", sp2.getName());
        Assertions.assertEquals(st, sp2.getType());
        Assertions.assertNull(sp2.getTransposedBy());
      }
      DFeature _get_10 = sAggr.getFeatures().get(1);
      final DQuery sq2 = ((DQuery) _get_10);
      Assertions.assertEquals("sq2", sq2.getName());
      Assertions.assertTrue(sq2.isSynthetic());
      Assertions.assertEquals(sq2Deduction, sq2.getTransposedBy());
      Assertions.assertEquals(q, sq2.getTransposedBy().getTranspositionRule().getSource());
      {
        Assertions.assertEquals(1, sq2.getParameters().size());
        DQueryParameter _get_11 = sq2.getParameters().get(0);
        final DQueryParameter sp0 = ((DQueryParameter) _get_11);
        Assertions.assertTrue(sp0.isSynthetic());
        Assertions.assertEquals("p0", sp0.getName());
        Assertions.assertEquals(st, sp0.getType());
        ITransposition _transposedBy = sp0.getTransposedBy();
        final TQueryParameterTransposition sp0Deduction = ((TQueryParameterTransposition) _transposedBy);
        TTranspositionRule _transpositionRule_2 = sp0Deduction.getTranspositionRule();
        Assertions.assertTrue((_transpositionRule_2 instanceof TGrabRule));
        Assertions.assertEquals(p1, sp0.getTransposedBy().getTranspositionRule().getSource());
      }
    } catch (Throwable _e) {
      throw Exceptions.sneakyThrow(_e);
    }
  }
  
  @Test
  public void grabAggregate() {
    try {
      final ResourceSet resourceSet = this.resourceSetProvider.get();
      final DmxModel dmx = this.loadDmx(resourceSet);
      DType _get = dmx.getTypes().get(0);
      final DmxArchetype at = ((DmxArchetype) _get);
      final DInformationModel dim = this.loadComponentDim(resourceSet, at);
      final DAggregate acomp = dim.getAggregates().get(0);
      DType _get_1 = acomp.getTypes().get(0);
      final DEntityType a = ((DEntityType) _get_1);
      DFeature _get_2 = a.getFeatures().get(0);
      final DAttribute x = ((DAttribute) _get_2);
      StringConcatenation _builder = new StringConcatenation();
      _builder.append("system SM");
      _builder.newLine();
      _builder.append("core information model SM1 {");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("grab primitive dm.types.AT as ST");
      _builder.newLine();
      _builder.append("\t");
      _builder.append("grab aggregate DM.AComp as SAggr {}");
      _builder.newLine();
      _builder.append("}");
      _builder.newLine();
      final DNamespace smNS = this.simParseHelper.parse(_builder, resourceSet);
      this.assertNoParseErrors(smNS, "sm");
      DModel _model = smNS.getModel();
      final SInformationModel sm = ((SInformationModel) _model);
      Assertions.assertNotNull(sm);
      Assertions.assertEquals(2, sm.getTypes().size());
      DType _get_3 = sm.getTypes().get(0);
      final TPrimitiveTransposition stDeduction = ((TPrimitiveTransposition) _get_3);
      Assertions.assertFalse(stDeduction.isSynthetic());
      TTranspositionRule _transpositionRule = stDeduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule instanceof TGrabRule));
      DType _get_4 = sm.getTypes().get(1);
      final DPrimitive st = ((DPrimitive) _get_4);
      Assertions.assertEquals("ST", st.getName());
      Assertions.assertTrue(st.isSynthetic());
      Assertions.assertEquals(stDeduction, st.getTransposedBy());
      Assertions.assertEquals(at, st.getTransposedBy().getTranspositionRule().getSource());
      Assertions.assertEquals(2, sm.getAggregates().size());
      DAggregate _get_5 = sm.getAggregates().get(0);
      final TAggregateTransposition sAggrDeduction = ((TAggregateTransposition) _get_5);
      Assertions.assertFalse(sAggrDeduction.isSynthetic());
      TTranspositionRule _transpositionRule_1 = sAggrDeduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule_1 instanceof TGrabAggregateRule));
      DAggregate _get_6 = sm.getAggregates().get(1);
      final DAggregate sAggr = ((DAggregate) _get_6);
      Assertions.assertTrue(sAggr.isSynthetic());
      Assertions.assertEquals(sAggrDeduction, sAggr.getTransposedBy());
      Assertions.assertEquals(acomp, sAggr.getTransposedBy().getTranspositionRule().getSource());
      Assertions.assertEquals(1, sAggr.getTypes().size());
      DType _get_7 = sAggr.getTypes().get(0);
      final DEntityType sma = ((DEntityType) _get_7);
      Assertions.assertEquals("A", sma.getName());
      Assertions.assertTrue(sma.isSynthetic());
      ITransposition _transposedBy = sma.getTransposedBy();
      final TImplicitTransposition smaDeduction = ((TImplicitTransposition) _transposedBy);
      TTranspositionRule _transpositionRule_2 = smaDeduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule_2 instanceof TGrabRule));
      Assertions.assertEquals(a, sma.getTransposedBy().getTranspositionRule().getSource());
      Assertions.assertEquals(1, sma.getFeatures().size());
      DFeature _get_8 = sma.getFeatures().get(0);
      final DAttribute smx = ((DAttribute) _get_8);
      Assertions.assertTrue(smx.isSynthetic());
      Assertions.assertEquals("x", smx.getName());
      Assertions.assertEquals(st, smx.getType());
      ITransposition _transposedBy_1 = smx.getTransposedBy();
      final TImplicitTransposition smxDeduction = ((TImplicitTransposition) _transposedBy_1);
      TTranspositionRule _transpositionRule_3 = smxDeduction.getTranspositionRule();
      Assertions.assertTrue((_transpositionRule_3 instanceof TGrabRule));
      Assertions.assertEquals(x, smx.getTransposedBy().getTranspositionRule().getSource());
    } catch (Throwable _e) {
      throw Exceptions.sneakyThrow(_e);
    }
  }
  
  protected void assertNoParseErrors(final DNamespace ns, final String name) {
    Assertions.assertNotNull(ns);
    final EList<Resource.Diagnostic> errors = ns.eResource().getErrors();
    boolean _isEmpty = errors.isEmpty();
    StringConcatenation _builder = new StringConcatenation();
    _builder.append("Unexpected errors in ");
    _builder.append(name);
    _builder.append(" \': ");
    String _join = IterableExtensions.join(errors, ", ");
    _builder.append(_join);
    Assertions.assertTrue(_isEmpty, _builder.toString());
  }
}
